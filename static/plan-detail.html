<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¡åˆ’è¯¦æƒ… - è¿åŠ¨ç®¡å®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">ğŸƒ è¿åŠ¨ç®¡å®¶</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">è¿”å›é¦–é¡µ</a>
                    <button onclick="Auth.logout()" class="text-gray-600 hover:text-gray-900">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="error-container"></div>
        <div id="success-container"></div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">åŠ è½½ä¸­...</p>
        </div>

        <!-- è®¡åˆ’è¯¦æƒ… -->
        <div id="plan-detail" class="hidden">
            <!-- è®¡åˆ’å¤´éƒ¨ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h2 id="plan-name" class="text-3xl font-bold text-gray-900 mb-2"></h2>
                        <p id="plan-description" class="text-gray-600 mb-4"></p>

                        <!-- è®­ç»ƒç»Ÿè®¡ -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                <div class="text-2xl font-bold text-blue-600" id="stat-total-executions">-</div>
                                <div class="text-xs text-gray-600 mt-1">æ€»è®­ç»ƒæ¬¡æ•°</div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3 border border-green-100">
                                <div class="text-lg font-bold text-green-600" id="stat-last-training">-</div>
                                <div class="text-xs text-gray-600 mt-1">æœ€è¿‘è®­ç»ƒ</div>
                            </div>
                        </div>
                    </div>
                    <!-- çŠ¶æ€å’Œç®¡ç†æŒ‰é’® -->
                    <div class="ml-8 flex flex-col items-end">
                        <span id="plan-status-badge" class="mb-4"></span>
                        <div class="flex flex-col space-y-2">
                            <button
                                onclick="editPlan()"
                                class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs hover:bg-blue-700 transition duration-200"
                            >
                                ç¼–è¾‘è®¡åˆ’
                            </button>
                            <button
                                onclick="togglePlanStatus()"
                                id="toggle-status-btn"
                                class="bg-yellow-600 text-white px-4 py-1.5 rounded text-xs hover:bg-yellow-700 transition duration-200"
                            >
                                æš‚åœè®¡åˆ’
                            </button>
                            <button
                                onclick="deletePlan()"
                                class="bg-red-600 text-white px-4 py-1.5 rounded text-xs hover:bg-red-700 transition duration-200"
                            >
                                åˆ é™¤è®¡åˆ’
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mt-6">
                    <button
                        onclick="showRecordCompletionModal()"
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200"
                    >
                        âœ“ è®°å½•å®Œæˆæƒ…å†µ
                    </button>
                    <button
                        onclick="showInviteModal()"
                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition duration-200"
                    >
                        ğŸ‘¥ é‚€è¯·å¥½å‹
                    </button>
                    <button
                        onclick="showLeaderboard()"
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-200"
                    >
                        ğŸ† æ’è¡Œæ¦œ
                    </button>
                </div>
            </div>

            <!-- é”»ç‚¼é¡¹ç›®åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">é”»ç‚¼é¡¹ç›®</h3>
                    <button
                        onclick="showAddExerciseModal()"
                        class="text-blue-600 hover:text-blue-800 font-medium"
                    >
                        + æ·»åŠ é¡¹ç›®
                    </button>
                </div>

                <div id="exercises-list" class="space-y-4">
                    <!-- é”»ç‚¼é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å®Œæˆå†å²å’Œç»Ÿè®¡ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">è®­ç»ƒå®Œæˆæƒ…å†µ</h3>
                </div>

                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div id="completion-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-blue-600 font-medium">æ€»è®­ç»ƒæ¬¡æ•°</p>
                        <p class="text-3xl font-bold text-blue-900" id="stat-total-count">-</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-green-600 font-medium">å¹³å‡å®Œæˆç‡</p>
                        <p class="text-3xl font-bold text-green-900" id="stat-avg-completion">-</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <p class="text-sm text-purple-600 font-medium">æœ€è¿‘è®­ç»ƒ</p>
                        <p class="text-lg font-bold text-purple-900" id="stat-last-date">-</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <p class="text-sm text-orange-600 font-medium">æœ¬å‘¨è®­ç»ƒ</p>
                        <p class="text-3xl font-bold text-orange-900" id="stat-week-count">-</p>
                    </div>
                </div>

                <!-- å†å²è®°å½•åˆ—è¡¨ -->
                <div id="execution-history" class="space-y-3">
                    <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div id="no-executions" class="text-center py-8 text-gray-500" style="display: none;">
                    è¿˜æ²¡æœ‰è®­ç»ƒè®°å½•ï¼Œç‚¹å‡»ä¸Šæ–¹"è®°å½•å®Œæˆæƒ…å†µ"å¼€å§‹è®°å½•å§ï¼
                </div>
            </div>

            <!-- æé†’è®¾ç½® -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">æé†’è®¾ç½®</h3>
                    <div class="flex space-x-3">
                        <button
                            onclick="exportToCalendar()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm"
                        >
                            ğŸ“… å¯¼å‡ºåˆ°æ—¥å†
                        </button>
                        <button
                            onclick="showAddReminderModal()"
                            class="text-blue-600 hover:text-blue-800 font-medium"
                        >
                            + æ·»åŠ æé†’
                        </button>
                    </div>
                </div>

                <div id="reminders-list" class="space-y-4">
                    <!-- æé†’å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div id="no-reminders" class="text-center py-8 text-gray-500" style="display: none;">
                    è¿˜æ²¡æœ‰è®¾ç½®æé†’
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é”»ç‚¼é¡¹ç›®çš„Modal -->
    <div id="add-exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">æ·»åŠ é”»ç‚¼é¡¹ç›®</h3>
            <form id="add-exercise-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¡¹ç›®åç§°</label>
                    <input type="text" id="new-exercise-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="ä¾‹å¦‚ï¼šæ·±è¹²">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="new-exercise-duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¬¡æ•°</label>
                    <input type="number" id="new-exercise-reps" class="w-full px-4 py-2 border border-gray-300 rounded-lg" min="1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¼ºåº¦</label>
                    <select id="new-exercise-intensity" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="low">ä½</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="high">é«˜</option>
                    </select>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">æ·»åŠ </button>
                    <button type="button" onclick="hideAddExerciseModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ æé†’çš„Modal -->
    <div id="add-reminder-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">æ·»åŠ æé†’</h3>
            <form id="add-reminder-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æé†’æ—¶é—´</label>
                    <input type="time" id="new-reminder-time" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¢‘ç‡</label>
                    <select id="new-reminder-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯å‘¨</option>
                    </select>
                </div>
                <div id="days-selector">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é‡å¤æ—¥æœŸ</label>
                    <div class="flex flex-wrap gap-2">
                        <label class="inline-flex items-center"><input type="checkbox" value="1" class="mr-1"> å‘¨ä¸€</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="2" class="mr-1"> å‘¨äºŒ</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="3" class="mr-1"> å‘¨ä¸‰</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="4" class="mr-1"> å‘¨å››</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="5" class="mr-1"> å‘¨äº”</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="6" class="mr-1"> å‘¨å…­</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="7" class="mr-1"> å‘¨æ—¥</label>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">æ·»åŠ </button>
                    <button type="button" onclick="hideAddReminderModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è®°å½•å®Œæˆæƒ…å†µçš„Modal -->
    <div id="record-completion-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">è®°å½•è®­ç»ƒå®Œæˆæƒ…å†µ</h3>
            <form id="record-completion-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è®­ç»ƒæ—¥æœŸ</label>
                    <input type="date" id="execution-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è®­ç»ƒé¡¹ç›®å®Œæˆæƒ…å†µ</label>
                    <div id="exercises-checklist" class="space-y-3 border border-gray-200 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„è®­ç»ƒé¡¹ç›®åˆ—è¡¨ -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¤‡æ³¨</label>
                    <textarea id="execution-notes" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="è®°å½•æœ¬æ¬¡è®­ç»ƒçš„æ„Ÿå—ã€æ³¨æ„äº‹é¡¹ç­‰..."></textarea>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">ä¿å­˜</button>
                    <button type="button" onclick="hideRecordCompletionModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é‚€è¯·å¥½å‹çš„Modal -->
    <div id="invite-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">é‚€è¯·å¥½å‹</h3>
            <form id="invite-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¥½å‹é‚®ç®±</label>
                    <input
                        type="email"
                        id="invitee-email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                        placeholder="è¯·è¾“å…¥å¥½å‹çš„é‚®ç®±åœ°å€"
                        required
                    >
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">å‘é€é‚€è¯·</button>
                    <button type="button" onclick="hideInviteModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œçš„Modal -->
    <div id="leaderboard-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">ğŸ† æ’è¡Œæ¦œ</h3>
                <button onclick="hideLeaderboard()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="leaderboard-content">
                <!-- æ’è¡Œæ¦œå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script src="/js/api.js?v=5"></script>
    <script>
        Auth.requireAuth();

        let currentPlan = null;
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('id');

        if (!planId) {
            window.location.href = '/';
        }

        async function loadPlanDetail() {
            try {
                currentPlan = await API.getPlanDetail(planId);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('plan-detail').classList.remove('hidden');

                // å¡«å……è®¡åˆ’ä¿¡æ¯
                document.getElementById('plan-name').textContent = currentPlan.name;
                document.getElementById('plan-description').textContent = currentPlan.description || 'æš‚æ— æè¿°';

                const statusBadge = currentPlan.status === 'active'
                    ? '<span class="inline-block px-3 py-1 text-sm font-semibold text-green-800 bg-green-200 rounded">è¿›è¡Œä¸­</span>'
                    : '<span class="inline-block px-3 py-1 text-sm font-semibold text-yellow-800 bg-yellow-200 rounded">å·²æš‚åœ</span>';
                document.getElementById('plan-status-badge').innerHTML = statusBadge;

                // æ›´æ–°æš‚åœ/æ¢å¤æŒ‰é’®
                const toggleBtn = document.getElementById('toggle-status-btn');
                toggleBtn.textContent = currentPlan.status === 'active' ? 'æš‚åœè®¡åˆ’' : 'æ¢å¤è®¡åˆ’';

                // åŠ è½½å¹¶æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
                await loadStatistics();

                // æ¸²æŸ“é”»ç‚¼é¡¹ç›®
                renderExercises();

                // æ¸²æŸ“æé†’
                renderReminders();

                // åŠ è½½è®­ç»ƒå®Œæˆå†å²å’Œç»Ÿè®¡
                await loadExecutionHistory();
            } catch (error) {
                UI.showError('åŠ è½½è®¡åˆ’è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        async function loadStatistics() {
            try {
                // è·å–è®­ç»ƒè®°å½•
                const response = await API.getPlanExecutions(1, 100, planId);
                const executions = response.plan_executions || [];

                // 1. æ€»è®­ç»ƒæ¬¡æ•°
                const totalExecutions = executions.length;
                document.getElementById('stat-total-executions').textContent = totalExecutions;

                // 2. æœ€è¿‘è®­ç»ƒæ—¶é—´
                if (executions.length > 0) {
                    const lastExecution = executions[0];
                    const lastDate = new Date(lastExecution.execution_date);
                    const today = new Date();
                    const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

                    let lastTrainingText;
                    if (diffDays === 0) {
                        lastTrainingText = 'ä»Šå¤©';
                    } else if (diffDays === 1) {
                        lastTrainingText = 'æ˜¨å¤©';
                    } else if (diffDays < 7) {
                        lastTrainingText = diffDays + 'å¤©å‰';
                    } else {
                        lastTrainingText = lastDate.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                    }
                    document.getElementById('stat-last-training').textContent = lastTrainingText;
                } else {
                    document.getElementById('stat-last-training').textContent = 'æœªå¼€å§‹';
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºé»˜è®¤å€¼
                document.getElementById('stat-total-executions').textContent = '0';
                document.getElementById('stat-last-training').textContent = '-';
            }
        }

        function renderExercises() {
            const container = document.getElementById('exercises-list');
            container.innerHTML = '';

            currentPlan.exercises.forEach(exercise => {
                const detail = exercise.duration_minutes
                    ? `${exercise.duration_minutes}åˆ†é’Ÿ`
                    : `${exercise.repetitions}æ¬¡`;
                const intensityMap = { low: 'ä½å¼ºåº¦', medium: 'ä¸­å¼ºåº¦', high: 'é«˜å¼ºåº¦' };

                container.innerHTML += `
                    <div class="border border-gray-200 rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-gray-900">${exercise.name}</h4>
                            <p class="text-sm text-gray-600">${detail} Â· ${intensityMap[exercise.intensity]}</p>
                        </div>
                        <button onclick="deleteExercise('${exercise.id}')" class="text-red-600 hover:text-red-800">åˆ é™¤</button>
                    </div>
                `;
            });
        }

        function renderReminders() {
            const container = document.getElementById('reminders-list');
            const noReminders = document.getElementById('no-reminders');
            container.innerHTML = '';

            if (!currentPlan.reminders || currentPlan.reminders.length === 0) {
                noReminders.style.display = 'block';
                return;
            }

            noReminders.style.display = 'none';
            currentPlan.reminders.forEach(reminder => {
                const frequencyMap = { daily: 'æ¯å¤©', weekly: 'æ¯å‘¨' };
                const daysMap = { 1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'æ—¥' };
                const daysStr = reminder.days_of_week ? reminder.days_of_week.map(d => 'å‘¨' + daysMap[d]).join(', ') : '';

                container.innerHTML += `
                    <div class="border border-gray-200 rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-900">${reminder.reminder_time} Â· ${frequencyMap[reminder.frequency]}</p>
                            ${daysStr ? `<p class="text-sm text-gray-600">${daysStr}</p>` : ''}
                        </div>
                        <button onclick="deleteReminder('${reminder.id}')" class="text-red-600 hover:text-red-800">åˆ é™¤</button>
                    </div>
                `;
            });
        }

        function editPlan() {
            const name = prompt('è¾“å…¥æ–°çš„è®¡åˆ’åç§°:', currentPlan.name);
            if (!name) return;

            API.updatePlan(planId, { name }).then(() => {
                UI.showSuccess('è®¡åˆ’å·²æ›´æ–°');
                loadPlanDetail();
            }).catch(error => {
                UI.showError('æ›´æ–°å¤±è´¥: ' + error.message);
            });
        }

        function togglePlanStatus() {
            alert('æš‚åœ/æ¢å¤åŠŸèƒ½å°†åœ¨ä¸‹ä¸€ç‰ˆæœ¬å®ç°');
        }

        function deletePlan() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¡åˆ’å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) return;

            API.deletePlan(planId).then(() => {
                window.location.href = '/?success=deleted';
            }).catch(error => {
                UI.showError('åˆ é™¤å¤±è´¥: ' + error.message);
            });
        }

        function showAddExerciseModal() {
            document.getElementById('add-exercise-modal').classList.remove('hidden');
        }

        function hideAddExerciseModal() {
            document.getElementById('add-exercise-modal').classList.add('hidden');
            document.getElementById('add-exercise-form').reset();
        }

        function showAddReminderModal() {
            document.getElementById('add-reminder-modal').classList.remove('hidden');
        }

        function hideAddReminderModal() {
            document.getElementById('add-reminder-modal').classList.add('hidden');
            document.getElementById('add-reminder-form').reset();
        }

        document.getElementById('add-exercise-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('new-exercise-name').value;
            const duration = document.getElementById('new-exercise-duration').value;
            const reps = document.getElementById('new-exercise-reps').value;
            const intensity = document.getElementById('new-exercise-intensity').value;

            if (!duration && !reps) {
                UI.showError('æ—¶é•¿å’Œæ¬¡æ•°è‡³å°‘å¡«å†™ä¸€ä¸ª');
                return;
            }

            try {
                const exerciseData = { name, intensity };
                if (duration) exerciseData.duration_minutes = parseInt(duration);
                if (reps) exerciseData.repetitions = parseInt(reps);

                await API.addExercise(planId, exerciseData);
                hideAddExerciseModal();
                UI.showSuccess('é”»ç‚¼é¡¹ç›®å·²æ·»åŠ ');
                loadPlanDetail();
            } catch (error) {
                UI.showError('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        });

        document.getElementById('add-reminder-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const time = document.getElementById('new-reminder-time').value;
            const frequency = document.getElementById('new-reminder-frequency').value;
            const days = Array.from(document.querySelectorAll('#days-selector input:checked')).map(cb => parseInt(cb.value));

            if ((frequency === 'weekly' || frequency === 'custom') && days.length === 0) {
                UI.showError('è¯·é€‰æ‹©é‡å¤æ—¥æœŸ');
                return;
            }

            try {
                const reminderData = {
                    reminder_time: time + ':00',
                    frequency,
                    days_of_week: days.length > 0 ? days : null,
                    is_enabled: true
                };

                await API.createReminder(planId, reminderData);
                hideAddReminderModal();
                UI.showSuccess('æé†’å·²æ·»åŠ ');
                loadPlanDetail();
            } catch (error) {
                UI.showError('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        });

        async function deleteExercise(exerciseId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé”»ç‚¼é¡¹ç›®å—ï¼Ÿ')) return;

            try {
                await API.deleteExercise(planId, exerciseId);
                UI.showSuccess('é”»ç‚¼é¡¹ç›®å·²åˆ é™¤');
                loadPlanDetail();
            } catch (error) {
                UI.showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function deleteReminder(reminderId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæé†’å—ï¼Ÿ')) return;

            try {
                await API.deleteReminder(planId, reminderId);
                UI.showSuccess('æé†’å·²åˆ é™¤');
                loadPlanDetail();
            } catch (error) {
                UI.showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        async function exportToCalendar() {
            try {
                UI.showSuccess('æ­£åœ¨å¯¼å‡ºæ—¥å†æ–‡ä»¶...');
                await API.exportPlanCalendar(planId);
                UI.showSuccess('æ—¥å†å·²å¯¼å‡ºï¼æ‚¨å¯ä»¥å°† .ics æ–‡ä»¶å¯¼å…¥åˆ°ç³»ç»Ÿæ—¥å†åº”ç”¨ä¸­ã€‚');
            } catch (error) {
                UI.showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        function showRecordCompletionModal() {
            // è®¾ç½®ä»Šå¤©ä¸ºé»˜è®¤æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('execution-date').value = today;

            // ç”Ÿæˆè®­ç»ƒé¡¹ç›®æ¸…å•
            const checklist = document.getElementById('exercises-checklist');
            checklist.innerHTML = '';

            if (!currentPlan.exercises || currentPlan.exercises.length === 0) {
                checklist.innerHTML = '<p class="text-gray-500 text-center py-4">è¯¥è®¡åˆ’è¿˜æ²¡æœ‰è®­ç»ƒé¡¹ç›®</p>';
                return;
            }

            currentPlan.exercises.forEach(exercise => {
                const detail = exercise.duration_minutes
                    ? `è®¡åˆ’: ${exercise.duration_minutes}åˆ†é’Ÿ`
                    : `è®¡åˆ’: ${exercise.repetitions}æ¬¡`;

                checklist.innerHTML += `
                    <div class="border border-gray-200 rounded-lg p-3" data-exercise-id="${exercise.id}">
                        <div class="flex items-start space-x-3">
                            <input type="checkbox"
                                   id="ex-${exercise.id}"
                                   checked
                                   class="mt-1 w-5 h-5 text-green-600 rounded"
                                   onchange="toggleExerciseFields('${exercise.id}')">
                            <div class="flex-1">
                                <label for="ex-${exercise.id}" class="font-medium text-gray-900 cursor-pointer">
                                    ${exercise.name}
                                </label>
                                <p class="text-sm text-gray-600">${detail}</p>
                                <div class="mt-2 space-y-2" id="fields-${exercise.id}">
                                    ${exercise.duration_minutes ? `
                                        <input type="number"
                                               id="duration-${exercise.id}"
                                               placeholder="å®é™…æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰"
                                               class="w-full px-3 py-1 border border-gray-300 rounded text-sm"
                                               min="1">
                                    ` : ''}
                                    ${exercise.repetitions ? `
                                        <input type="number"
                                               id="reps-${exercise.id}"
                                               placeholder="å®é™…æ¬¡æ•°"
                                               class="w-full px-3 py-1 border border-gray-300 rounded text-sm"
                                               min="1">
                                    ` : ''}
                                    <input type="text"
                                           id="notes-${exercise.id}"
                                           placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
                                           class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('record-completion-modal').classList.remove('hidden');
        }

        function hideRecordCompletionModal() {
            document.getElementById('record-completion-modal').classList.add('hidden');
            document.getElementById('record-completion-form').reset();
        }

        function toggleExerciseFields(exerciseId) {
            const checkbox = document.getElementById(`ex-${exerciseId}`);
            const fields = document.getElementById(`fields-${exerciseId}`);

            if (checkbox.checked) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        }

        document.getElementById('record-completion-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const executionDate = document.getElementById('execution-date').value;
            const notes = document.getElementById('execution-notes').value;

            // æ”¶é›†æ¯ä¸ªè®­ç»ƒé¡¹ç›®çš„å®Œæˆæƒ…å†µ
            const exerciseExecutions = [];
            currentPlan.exercises.forEach(exercise => {
                const checkbox = document.getElementById(`ex-${exercise.id}`);
                const completed = checkbox.checked;

                const execution = {
                    exercise_id: exercise.id,
                    completed: completed
                };

                if (completed) {
                    const duration = document.getElementById(`duration-${exercise.id}`)?.value;
                    const reps = document.getElementById(`reps-${exercise.id}`)?.value;
                    const exerciseNotes = document.getElementById(`notes-${exercise.id}`)?.value;

                    if (duration) execution.actual_duration_minutes = parseInt(duration);
                    if (reps) execution.actual_repetitions = parseInt(reps);
                    if (exerciseNotes) execution.notes = exerciseNotes;
                }

                exerciseExecutions.push(execution);
            });

            if (exerciseExecutions.length === 0) {
                UI.showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®­ç»ƒé¡¹ç›®');
                return;
            }

            try {
                const executionData = {
                    plan_id: planId,
                    execution_date: executionDate,
                    notes: notes || null,
                    exercise_executions: exerciseExecutions
                };

                await API.createPlanExecution(executionData);
                hideRecordCompletionModal();
                UI.showSuccess('è®­ç»ƒå®Œæˆæƒ…å†µå·²è®°å½•ï¼');
                // é‡æ–°åŠ è½½å®Œæˆå†å²å’Œç»Ÿè®¡æ•°æ®
                loadExecutionHistory();
                loadStatistics();
            } catch (error) {
                UI.showError('è®°å½•å¤±è´¥: ' + error.message);
            }
        });

        async function loadExecutionHistory() {
            try {
                const response = await API.getPlanExecutions(1, 100, planId);
                const executions = response.plan_executions || [];

                const historyContainer = document.getElementById('execution-history');
                const noExecutions = document.getElementById('no-executions');

                if (executions.length === 0) {
                    noExecutions.style.display = 'block';
                    historyContainer.innerHTML = '';
                    // æ¸…ç©ºç»Ÿè®¡
                    document.getElementById('stat-total-count').textContent = '0';
                    document.getElementById('stat-avg-completion').textContent = '0%';
                    document.getElementById('stat-last-date').textContent = '-';
                    document.getElementById('stat-week-count').textContent = '0';
                    return;
                }

                noExecutions.style.display = 'none';

                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                const totalCount = executions.length;
                const avgCompletion = executions.reduce((sum, ex) => sum + ex.completion_rate, 0) / totalCount;
                const lastExecution = executions[0]; // å·²æŒ‰æ—¥æœŸé™åºæ’åˆ—

                // è®¡ç®—æœ¬å‘¨è®­ç»ƒæ¬¡æ•°
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const weekCount = executions.filter(ex => {
                    const exDate = new Date(ex.execution_date);
                    return exDate >= oneWeekAgo;
                }).length;

                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                document.getElementById('stat-total-count').textContent = totalCount;
                document.getElementById('stat-avg-completion').textContent = avgCompletion.toFixed(1) + '%';
                document.getElementById('stat-last-date').textContent = formatDate(lastExecution.execution_date);
                document.getElementById('stat-week-count').textContent = weekCount;

                // æ¸²æŸ“å†å²è®°å½•
                historyContainer.innerHTML = '';
                executions.forEach(execution => {
                    const completionColor = execution.completion_rate === 100 ? 'green' :
                                          execution.completion_rate >= 80 ? 'blue' :
                                          execution.completion_rate >= 50 ? 'yellow' : 'red';

                    historyContainer.innerHTML += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="font-semibold text-gray-900">${formatDate(execution.execution_date)}</span>
                                        <span class="inline-block px-2 py-1 text-xs font-semibold text-${completionColor}-800 bg-${completionColor}-200 rounded">
                                            å®Œæˆç‡: ${execution.completion_rate.toFixed(1)}%
                                        </span>
                                        <span class="text-sm text-gray-600">
                                            ${execution.completed_exercises}/${execution.total_exercises} é¡¹å®Œæˆ
                                        </span>
                                    </div>
                                    ${execution.plan_name ? `<p class="text-sm text-gray-500 mb-1">${execution.plan_name}</p>` : ''}
                                </div>
                                <button onclick="viewExecutionDetail('${execution.id}')"
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('åŠ è½½å®Œæˆå†å²å¤±è´¥:', error);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return 'ä»Šå¤©';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'æ˜¨å¤©';
            } else {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}æœˆ${day}æ—¥`;
            }
        }

        async function viewExecutionDetail(executionId) {
            try {
                const execution = await API.getPlanExecution(executionId);

                // Calculate overall completion rate based on actual vs planned
                let exerciseRates = [];
                execution.exercise_executions.forEach(ex => {
                    const exercise = currentPlan.exercises.find(e => e.id === ex.exercise_id);
                    if (!ex.completed) {
                        exerciseRates.push(0);
                    } else if (exercise) {
                        if (exercise.duration_minutes && ex.actual_duration_minutes) {
                            const rate = Math.min((ex.actual_duration_minutes / exercise.duration_minutes) * 100, 100);
                            exerciseRates.push(rate);
                        } else if (exercise.repetitions && ex.actual_repetitions) {
                            const rate = Math.min((ex.actual_repetitions / exercise.repetitions) * 100, 100);
                            exerciseRates.push(rate);
                        } else {
                            exerciseRates.push(100);
                        }
                    } else {
                        exerciseRates.push(100);
                    }
                });
                const overallRate = exerciseRates.length > 0 ? (exerciseRates.reduce((a, b) => a + b, 0) / exerciseRates.length) : 0;

                let detailHtml = `
                    <div class="space-y-3">
                        <p class="text-lg font-semibold">è®­ç»ƒæ—¥æœŸ: ${formatDate(execution.execution_date)}</p>
                        <p class="text-gray-700">æ•´ä½“å®Œæˆç‡: ${overallRate.toFixed(1)}%</p>
                `;

                detailHtml += '<div class="border-t pt-3 mt-3"><p class="font-medium mb-2">è®­ç»ƒé¡¹ç›®è¯¦æƒ…:</p>';

                execution.exercise_executions.forEach((ex, index) => {
                    const exercise = currentPlan.exercises.find(e => e.id === ex.exercise_id);
                    if (exercise) {
                        const rate = exerciseRates[index];
                        const rateColor = rate === 0 ? 'red' : rate === 100 ? 'green' : rate >= 80 ? 'blue' : 'yellow';
                        // åªæœ‰å®Œæˆç‡è¾¾åˆ°100%æ‰æ˜¾ç¤ºä¸ºå®Œæˆ
                        const isFullyCompleted = rate === 100;

                        detailHtml += `
                            <div class="mb-3 pl-4 pb-3 border-b border-gray-100">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="font-medium ${isFullyCompleted ? 'text-gray-900' : 'text-gray-400 line-through'}">
                                        ${isFullyCompleted ? 'âœ“' : 'âœ—'} ${exercise.name}
                                    </p>
                                    <span class="text-xs font-semibold px-2 py-1 rounded bg-${rateColor}-100 text-${rateColor}-800">
                                        ${rate.toFixed(1)}%
                                    </span>
                                </div>
                                ${exercise.duration_minutes ? `<p class="text-sm text-gray-600">è®¡åˆ’: ${exercise.duration_minutes}åˆ†é’Ÿ</p>` : ''}
                                ${exercise.repetitions ? `<p class="text-sm text-gray-600">è®¡åˆ’: ${exercise.repetitions}æ¬¡</p>` : ''}
                                ${ex.actual_duration_minutes ? `<p class="text-sm text-gray-700">å®é™…: ${ex.actual_duration_minutes}åˆ†é’Ÿ</p>` : ''}
                                ${ex.actual_repetitions ? `<p class="text-sm text-gray-700">å®é™…: ${ex.actual_repetitions}æ¬¡</p>` : ''}
                                ${ex.notes ? `<p class="text-sm text-gray-600 mt-1">å¤‡æ³¨: ${ex.notes}</p>` : ''}
                            </div>
                        `;
                    }
                });

                detailHtml += '</div>';

                if (execution.notes) {
                    detailHtml += `<div class="border-t pt-3 mt-3"><p class="font-medium">æ•´ä½“å¤‡æ³¨:</p><p class="text-gray-700">${execution.notes}</p></div>`;
                }

                detailHtml += '</div>';

                // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„å¼¹çª—æ˜¾ç¤ºè¯¦æƒ…
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">è®­ç»ƒè¯¦æƒ…</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        ${detailHtml}
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                UI.showError('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        // ========== é‚€è¯·å¥½å‹ç›¸å…³ ==========

        function showInviteModal() {
            document.getElementById('invite-modal').classList.remove('hidden');
        }

        function hideInviteModal() {
            document.getElementById('invite-modal').classList.add('hidden');
            document.getElementById('invite-form').reset();
        }

        document.getElementById('invite-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('invitee-email').value;

            try {
                await API.invitePlanMember(planId, email);
                UI.showSuccess(`å·²æˆåŠŸé‚€è¯· ${email}`);
                hideInviteModal();
            } catch (error) {
                UI.showError('é‚€è¯·å¤±è´¥: ' + error.message);
            }
        });

        // ========== æ’è¡Œæ¦œç›¸å…³ ==========

        async function showLeaderboard() {
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            await loadLeaderboard();
        }

        function hideLeaderboard() {
            document.getElementById('leaderboard-modal').classList.add('hidden');
        }

        async function loadLeaderboard() {
            try {
                const response = await API.getPlanLeaderboard(planId);
                const leaderboard = response.leaderboard || [];

                const container = document.getElementById('leaderboard-content');

                if (leaderboard.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-8">æš‚æ— æ’è¡Œæ•°æ®</p>';
                    return;
                }

                // æŒ‰å®Œæˆç‡æ’åºçš„æ’è¡Œæ¦œ
                const byCompletionRate = [...leaderboard].sort((a, b) => b.avg_completion_rate - a.avg_completion_rate);

                // æŒ‰è®­ç»ƒæ¬¡æ•°æ’åºçš„æ’è¡Œæ¦œ
                const byExecutionCount = [...leaderboard].sort((a, b) => b.total_executions - a.total_executions);

                let html = `
                    <!-- Tab åˆ‡æ¢ -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-4">
                            <button onclick="switchLeaderboardTab('rate')" id="tab-rate" class="leaderboard-tab px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                                å®Œæˆç‡æ’è¡Œæ¦œ
                            </button>
                            <button onclick="switchLeaderboardTab('count')" id="tab-count" class="leaderboard-tab px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                è®­ç»ƒæ¬¡æ•°æ’è¡Œæ¦œ
                            </button>
                        </nav>
                    </div>

                    <!-- å®Œæˆç‡æ’è¡Œæ¦œ -->
                    <div id="leaderboard-rate" class="leaderboard-content">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">æ’å</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç”¨æˆ·</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">å¹³å‡å®Œæˆç‡</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">è®­ç»ƒæ¬¡æ•°</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">æœ€åè®­ç»ƒ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                `;

                byCompletionRate.forEach((entry, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'text-yellow-600 font-bold text-xl' :
                                     rank === 2 ? 'text-gray-400 font-bold text-lg' :
                                     rank === 3 ? 'text-orange-600 font-bold text-lg' :
                                     'text-gray-600';
                    const rankDisplay = rank === 1 ? 'ğŸ¥‡' :
                                       rank === 2 ? 'ğŸ¥ˆ' :
                                       rank === 3 ? 'ğŸ¥‰' : rank;

                    const rateColor = entry.avg_completion_rate >= 90 ? 'text-green-600' :
                                     entry.avg_completion_rate >= 70 ? 'text-yellow-600' :
                                     'text-gray-600';

                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-center ${rankClass}">${rankDisplay}</td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900">${entry.user_name}</div>
                                <div class="text-sm text-gray-500">${entry.user_email}</div>
                            </td>
                            <td class="px-4 py-3 text-center ${rateColor} font-semibold text-lg">${entry.avg_completion_rate}%</td>
                            <td class="px-4 py-3 text-center text-gray-700">${entry.total_executions}æ¬¡</td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">
                                ${entry.last_execution_date ? new Date(entry.last_execution_date).toLocaleDateString('zh-CN') : '-'}
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- è®­ç»ƒæ¬¡æ•°æ’è¡Œæ¦œ -->
                    <div id="leaderboard-count" class="leaderboard-content hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">æ’å</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ç”¨æˆ·</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">è®­ç»ƒæ¬¡æ•°</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">å¹³å‡å®Œæˆç‡</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">æœ€åè®­ç»ƒ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                `;

                byExecutionCount.forEach((entry, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'text-yellow-600 font-bold text-xl' :
                                     rank === 2 ? 'text-gray-400 font-bold text-lg' :
                                     rank === 3 ? 'text-orange-600 font-bold text-lg' :
                                     'text-gray-600';
                    const rankDisplay = rank === 1 ? 'ğŸ¥‡' :
                                       rank === 2 ? 'ğŸ¥ˆ' :
                                       rank === 3 ? 'ğŸ¥‰' : rank;

                    const rateColor = entry.avg_completion_rate >= 90 ? 'text-green-600' :
                                     entry.avg_completion_rate >= 70 ? 'text-yellow-600' :
                                     'text-gray-600';

                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-center ${rankClass}">${rankDisplay}</td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900">${entry.user_name}</div>
                                <div class="text-sm text-gray-500">${entry.user_email}</div>
                            </td>
                            <td class="px-4 py-3 text-center text-gray-700 font-semibold text-lg">${entry.total_executions}æ¬¡</td>
                            <td class="px-4 py-3 text-center ${rateColor}">${entry.avg_completion_rate}%</td>
                            <td class="px-4 py-3 text-center text-sm text-gray-600">
                                ${entry.last_execution_date ? new Date(entry.last_execution_date).toLocaleDateString('zh-CN') : '-'}
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            } catch (error) {
                UI.showError('åŠ è½½æ’è¡Œæ¦œå¤±è´¥: ' + error.message);
            }
        }

        // Tab åˆ‡æ¢å‡½æ•°
        function switchLeaderboardTab(tab) {
            // æ›´æ–°tabæ ·å¼
            const tabs = document.querySelectorAll('.leaderboard-tab');
            tabs.forEach(t => {
                t.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
                t.classList.add('border-transparent', 'text-gray-500');
            });

            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600', 'font-medium');

            // åˆ‡æ¢å†…å®¹
            document.getElementById('leaderboard-rate').classList.add('hidden');
            document.getElementById('leaderboard-count').classList.add('hidden');
            document.getElementById(`leaderboard-${tab}`).classList.remove('hidden');
        }

        async function init() {
            await loadPlanDetail();
            await loadExecutionHistory();
        }

        init();
    </script>
</body>
</html>
